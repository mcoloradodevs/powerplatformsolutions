<!DOCTYPE html>
    <html>
    <head>
        <script>
            var clientApplication;
              (function () {
                var msalConfig = {
                    auth: {
                      clientId: '7c4c3f17-eb0a-4dd5-a35b-2472799dd4f5',
                      authority: 'https://login.microsoftonline.com/54a8e544-1927-4edb-8e84-4225ed8e739a'
                    },
                    cache: {
                      cacheLocation: 'localStorage',
                      storeAuthStateInCookie: false
                    }
                };
                if (!clientApplication) {
                  clientApplication = new Msal.UserAgentApplication(msalConfig);
                }
              } ());
          </script>
        <title>Contoso Sample Web Chat</title> 
        <!-- This styling is for the canvas demonstration purposes. It is recommended 
    that style is moved to separate file for organization in larger projects -->
        <style>
            html, body {
                height: 100%;
            }
            body {
                margin: 0;
            }
            h1 {
                font-size: 16px;
                font-family: Segoe UI;
                line-height: 20px;
                color: whitesmoke;
                display: table-cell;
                padding: 13px 0px 0px 20px;
            }
            .heading {
                background-color: black;
                height: 50px;
            }
            .main {
                margin: 18px;
                border-radius: 4px;
            }

            div[role="form"]{
                background-color: black;
            }        
            #webchat {
                position: fixed;
                height: calc(100% - 50px);
                width: 100%;
                top: 50px;
                overflow: hidden;
            }
          </style>
    </head>
    <body>
        <div>
            <div class="heading">

                <!-- Change the h1 text to change the bot name -->    
                <h1>Contoso Bot Name</h1>

            </div>
            <div id="webchat" role="main"></div>
        </div>    
      <!--MAKE THE BOT START THE CONVERSATION -->
      <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
      <script>
            const styleOptions = {
               // Add styleOptions to customize web chat canvas
               hideUploadButton: true
            };

            // Add your BOT ID below
            var BOT_ID = "062509f9-a36f-4459-ad2d-b3af67590fa7"; 

            var theURL = "https://powerva.microsoft.com/api/botmanagement/v1/directline/directlinetoken?botId=" + BOT_ID;

            const store = window.WebChat.createStore(
               {},
               ({ dispatch }) => next => action => {
                   if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
                      dispatch({
                          meta: {
                               method: "keyboard",
                           },
                           payload: {
                               activity: {
                                     channelData: {
                                          postBack: true,
                                     },
                                      //Web Chat will show the 'Greeting' System Topic message which has a trigger-phrase 'hello'
                                      name: 'startConversation',
                                      type: "event"
                                 },
                            },
                            type: "DIRECT_LINE/POST_ACTIVITY",
                       });
                 }
                 return next(action);
              }
           );
           fetch(theURL)
                .then(response => response.json())
                .then(conversationInfo => {
                    window.WebChat.renderWebChat(
                        {
                            directLine: window.WebChat.createDirectLine({
                                token: conversationInfo.token,
                            }),
                            store: store,
                            styleOptions: styleOptions
                        },
                        document.getElementById('webchat')
                    );
                })
                .catch(err => console.error("An error occurred: " + err));
        </script>
    <!--GET AUTHENTICATION TOKEN-->
    <script>
        function getOAuthCardResourceUri(activity) {
          if (activity &&
               activity.attachments &&
               activity.attachments[0] &&
               activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
               activity.attachments[0].content.tokenExchangeResource) {
                 // asking for token exchange with AAD
                 return activity.attachments[0].content.tokenExchangeResource.uri;
           }
        }
        
        function exchangeTokenAsync(resourceUri) {
          let user = clientApplication.getAccount();
           if (user) {
             let requestObj = {
               scopes: [resourceUri]
             };
             return clientApplication.acquireTokenSilent(requestObj)
               .then(function (tokenResponse) {
                 return tokenResponse.accessToken;
                 })
                 .catch(function (error) {
                   console.log(error);
                 });
                 }
                 else {
                 return Promise.resolve(null);
           }
        }
        </script>
    <script>
        (async function main() {
    
            // Add your BOT ID below 
            var BOT_ID = "062509f9-a36f-4459-ad2d-b3af67590fa7";
            var theURL = "https://powerva.microsoft.com/api/botmanagement/v1/directline/directlinetoken?botId=" + BOT_ID;
    
            const {
                token
            } = await fetchJSON(theURL);
            const directLine = window.WebChat.createDirectLine({
                token
            });
            var userID = clientApplication.account ? .accountIdentifier != null ?
                ("Your-customized-prefix-max-20-characters" + clientApplication.account.accountIdentifier).substr(0, 64) :
                (Math.random().toString() + Date.now().toString()).substr(0, 64); // Make sure this will not exceed 64 characters 
            const store = WebChat.createStore({}, ({
                dispatch
            }) => next => action => {
                const {
                    type
                } = action;
                if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                    dispatch({
                        type: 'WEB_CHAT/SEND_EVENT',
                        payload: {
                            name: 'startConversation',
                            type: 'event',
                            value: {
                                text: "hello"
                            }
                        }
                    });
                    return next(action);
                }
                if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;
                    let resourceUri;
                    if (activity.from && activity.from.role === 'bot' &&
                        (resourceUri = getOAuthCardResourceUri(activity))) {
                        exchangeTokenAsync(resourceUri).then(function(token) {
                            if (token) {
                                directLine.postActivity({
                                    type: 'invoke',
                                    name: 'signin/tokenExchange',
                                    value: {
                                        id: activity.attachments[0].content.tokenExchangeResource.id,
                                        connectionName: activity.attachments[0].content.connectionName,
                                        token,
                                    },
                                    "from": {
                                        id: userID,
                                        name: clientApplication.account.name,
                                        role: "user"
                                    }
                                }).subscribe(
                                    id => {
                                        if (id === 'retry') {
                                            // bot was not able to handle the invoke, so display the oauthCard
                                            return next(action);
                                        }
                                        // else: tokenexchange successful and we do not display the oauthCard
                                    },
                                    error => {
                                        // an error occurred to display the oauthCard
                                        return next(action);
                                    }
                                );
                                return;
                            } else
                                return next(action);
                        });
                    } else
                        return next(action);
                } else
                    return next(action);
            });
    
            const styleOptions = {
    
                // Add styleOptions to customize Web Chat canvas
                hideUploadButton: true
            };
    
            window.WebChat.renderWebChat({
                    directLine: directLine,
                    store,
                    userID: userID,
                    styleOptions
                },
                document.getElementById('webchat')
            );
        })().catch(err => console.error("An error occurred: " + err));
    </script>
      </body>
    </html>